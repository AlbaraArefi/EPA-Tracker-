<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pediatrics EPA Tracker ‚Äî Sidra Medicine</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',system-ui,sans-serif;background:#f0ede6;color:#1a1a2e;min-height:100vh}
#loading-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0a2342,#0d5c63);color:white;font-size:1rem;gap:.75rem}
#auth-screen{display:none;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0a2342 0%,#0d5c63 100%);padding:1rem}
.auth-card{background:white;border-radius:20px;padding:2.5rem;max-width:420px;width:100%;box-shadow:0 32px 80px rgba(0,0,0,0.35)}
.auth-logo{width:64px;height:64px;background:linear-gradient(135deg,#0d7377,#0a2342);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 1rem}
.auth-title{font-family:'DM Serif Display',serif;font-size:1.7rem;color:#0a2342;text-align:center;margin-bottom:.25rem}
.auth-sub{color:#9ca3af;font-size:.82rem;text-align:center;margin-bottom:1.75rem;line-height:1.5}
.tab-row{display:flex;background:#f3f4f6;border-radius:10px;padding:4px;margin-bottom:1.5rem}
.tab-btn{flex:1;padding:.5rem;border-radius:7px;border:none;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s;background:transparent;color:#9ca3af}
.tab-btn.active{background:white;color:#0a2342;box-shadow:0 1px 4px rgba(0,0,0,0.12)}
.auth-input{width:100%;padding:.85rem 1rem;border:2px solid #e5e7eb;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.95rem;outline:none;transition:border-color .2s;margin-bottom:.65rem;display:block}
.auth-input:focus{border-color:#0d7377}
.auth-btn{width:100%;padding:.9rem;background:linear-gradient(135deg,#0d7377,#0a2342);color:white;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;margin-top:.25rem}
.auth-btn:hover{opacity:.9;transform:translateY(-1px)}
.auth-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
.auth-error{background:#fef2f2;border:1px solid #fca5a5;color:#b91c1c;padding:.7rem 1rem;border-radius:8px;font-size:.82rem;margin-bottom:.75rem}
.auth-note{text-align:center;font-size:.75rem;color:#9ca3af;margin-top:1.25rem;line-height:1.6}
#app-screen{display:none}
.app-header{background:#0a2342;color:white;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.3)}
.app-header-inner{max-width:1100px;margin:0 auto;padding:0 1.25rem;height:60px;display:flex;align-items:center;justify-content:space-between;gap:1rem}
.app-logo{display:flex;align-items:center;gap:.7rem}
.app-logo-icon{width:34px;height:34px;background:#c9962a;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.app-logo-text{font-weight:700;font-size:.95rem;line-height:1.1}
.app-logo-sub{font-size:.6rem;opacity:.5;text-transform:uppercase;letter-spacing:.07em}
.header-right{display:flex;align-items:center;gap:.75rem;flex-shrink:0}
.save-msg{font-size:.78rem;color:#86efac;white-space:nowrap}
.user-name{font-size:.82rem;opacity:.65;white-space:nowrap}
.signout-btn{background:transparent;border:1px solid rgba(255,255,255,.3);color:white;padding:.3rem .8rem;border-radius:6px;font-size:.78rem;cursor:pointer;white-space:nowrap}
.signout-btn:hover{background:rgba(255,255,255,.1)}
.stats-section{background:#0a2342;color:white;padding:1.25rem 1.25rem 0}
.stats-inner{max-width:1100px;margin:0 auto}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.25rem}
.stat-val{font-family:'DM Serif Display',serif;font-size:1.9rem;color:#f0c060;display:block;line-height:1}
.stat-lbl{font-size:.65rem;opacity:.5;text-transform:uppercase;letter-spacing:.07em;margin-top:.2rem}
.prog-label{display:flex;justify-content:space-between;font-size:.65rem;opacity:.45;color:white;margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.06em}
.prog-track{height:7px;background:rgba(255,255,255,.15);border-radius:999px;overflow:hidden;margin-bottom:1.25rem}
.prog-fill{height:100%;background:linear-gradient(90deg,#14a085,#f0c060);border-radius:999px;transition:width .5s ease}
.content{max-width:1100px;margin:0 auto;padding:1.5rem 1.25rem}
.stage-tabs{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:1.25rem}
.stage-tab{padding:.4rem 1rem;border-radius:999px;border:2px solid transparent;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;background:white;color:#6b7280}
.stage-tab.active-all{background:#0a2342;color:white}
.stage-tab.active-TTD{background:#2563eb;color:white}
.stage-tab.active-Foundations{background:#059669;color:white}
.stage-tab.active-Core{background:#7c3aed;color:white}
.stage-tab.active-TTP{background:#dc2626;color:white}
.epa-list{display:flex;flex-direction:column;gap:.65rem}
.epa-card{background:white;border-radius:12px;box-shadow:0 2px 10px rgba(10,35,66,.07);border-left:5px solid #ccc;overflow:hidden;transition:box-shadow .2s}
.epa-card:hover{box-shadow:0 4px 20px rgba(10,35,66,.12)}
.epa-card[data-stage="TTD"]{border-left-color:#2563eb}
.epa-card[data-stage="Foundations"]{border-left-color:#059669}
.epa-card[data-stage="Core"]{border-left-color:#7c3aed}
.epa-card[data-stage="TTP"]{border-left-color:#dc2626}
.epa-card.epa-done{border-left-color:#c9962a!important}
.epa-header{display:flex;align-items:center;padding:1rem 1.25rem;cursor:pointer;gap:.75rem;user-select:none}
.epa-badge{font-size:.65rem;font-weight:700;padding:.2rem .55rem;border-radius:6px;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;flex-shrink:0;color:white}
.badge-TTD{background:#2563eb}.badge-Foundations{background:#059669}.badge-Core{background:#7c3aed}.badge-TTP{background:#dc2626}
.epa-title-wrap{flex:1;min-width:0}
.epa-title{font-weight:600;font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.epa-subtitle{font-size:.7rem;color:#9ca3af;margin-top:.1rem}
.epa-right{display:flex;align-items:center;gap:.55rem;flex-shrink:0}
.mini-bar{width:65px;height:5px;background:#f3f4f6;border-radius:999px;overflow:hidden}
.mini-fill{height:100%;border-radius:999px;transition:width .3s}
.mini-pct{font-size:.72rem;color:#9ca3af;white-space:nowrap}
.chevron{font-size:.65rem;color:#9ca3af;transition:transform .3s;display:inline-block}
.epa-card.open .chevron{transform:rotate(180deg)}
.epa-body{display:none;padding:0 1.25rem 1.25rem;border-top:1px solid #f3f4f6}
.epa-card.open .epa-body{display:block}
.epa-desc{font-size:.79rem;color:#6b7280;line-height:1.65;padding:.85rem 0;border-bottom:1px solid #f3f4f6;margin-bottom:.9rem}
.req-section-title{font-size:.67rem;text-transform:uppercase;letter-spacing:.09em;color:#9ca3af;font-weight:700;margin-bottom:.55rem}
.req-list{display:flex;flex-direction:column;gap:.35rem}
.req-row{display:flex;align-items:center;gap:.65rem;padding:.65rem .85rem;border-radius:8px;border:1px solid #f3f4f6;background:#f9fafb;transition:background .2s,border-color .2s}
.req-row.req-complete{background:#f0fdf4;border-color:#bbf7d0}
.req-info{flex:1;min-width:0}
.req-name{font-size:.82rem;font-weight:600}
.req-name-done{color:#065f46}
.req-detail{font-size:.7rem;color:#9ca3af;margin-top:.1rem}
.counter{display:flex;align-items:center;gap:.35rem;flex-shrink:0}
.cbtn{width:30px;height:30px;border-radius:50%;border:none;font-size:1.1rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.cbtn-minus{background:#fee2e2;color:#b91c1c}
.cbtn-minus:hover:not(:disabled){background:#fca5a5}
.cbtn-plus{background:#d1fae5;color:#065f46}
.cbtn-plus:hover:not(:disabled){background:#6ee7b7}
.cbtn:disabled{background:#f3f4f6!important;color:#d1d5db!important;cursor:not-allowed}
.cval{min-width:2.2rem;text-align:center;font-weight:700;font-size:.9rem;background:white;border:1px solid #e5e7eb;border-radius:6px;padding:.18rem .4rem}
.req-target{font-size:.75rem;color:#9ca3af;white-space:nowrap}
.req-tick{font-size:.95rem}
.complete-badge{display:inline-flex;align-items:center;gap:.4rem;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:.35rem .85rem;border-radius:999px;font-size:.72rem;font-weight:700;margin-top:.9rem;letter-spacing:.04em}
@media(max-width:600px){
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .epa-title{font-size:.82rem}
  .mini-bar{width:45px}
  .user-name{display:none}
}
</style>
</head>
<body>

<div id="loading-screen">
  <span style="font-size:1.5rem">ü©∫</span> Loading EPA Tracker‚Ä¶
</div>

<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">ü©∫</div>
    <h1 class="auth-title">EPA Tracker</h1>
    <p class="auth-sub">Pediatrics Residency ¬∑ Sidra Medicine<br>No email needed ‚Äî just a username & password</p>
    <div class="tab-row">
      <button class="tab-btn active" id="tab-login" onclick="showTab('login')">Sign In</button>
      <button class="tab-btn" id="tab-register" onclick="showTab('register')">Register</button>
    </div>
    <div id="auth-error" class="auth-error" style="display:none"></div>
    <div id="form-login">
      <input class="auth-input" id="login-user" type="text" placeholder="Username" autocomplete="username" autocapitalize="none"/>
      <input class="auth-input" id="login-pass" type="password" placeholder="Password" autocomplete="current-password"/>
      <button class="auth-btn" id="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
    </div>
    <div id="form-register" style="display:none">
      <input class="auth-input" id="reg-name" type="text" placeholder="Full name (e.g. Dr. Sarah Ali)"/>
      <input class="auth-input" id="reg-user" type="text" placeholder="Choose a username (e.g. drsarah)" autocomplete="username" autocapitalize="none"/>
      <input class="auth-input" id="reg-pass" type="password" placeholder="Choose a password (min 6 chars)" autocomplete="new-password"/>
      <input class="auth-input" id="reg-pass2" type="password" placeholder="Confirm password" autocomplete="new-password"/>
      <button class="auth-btn" id="reg-btn" onclick="doRegister()">Create Account ‚Üí</button>
    </div>
    <p class="auth-note">‚òÅÔ∏è Progress syncs across all your devices.<br/>No email required ‚Äî your data is private & secure.</p>
  </div>
</div>

<div id="app-screen">
  <div class="app-header">
    <div class="app-header-inner">
      <div class="app-logo">
        <div class="app-logo-icon">ü©∫</div>
        <div>
          <div class="app-logo-text">EPA Tracker</div>
          <div class="app-logo-sub">Pediatrics ¬∑ Sidra Medicine</div>
        </div>
      </div>
      <div class="header-right">
        <span class="save-msg" id="save-msg"></span>
        <span class="user-name" id="user-display"></span>
        <button class="signout-btn" onclick="doSignOut()">Sign Out</button>
      </div>
    </div>
  </div>
  <div class="stats-section">
    <div class="stats-inner">
      <div class="stats-grid">
        <div style="text-align:center"><span class="stat-val" id="s-obs">0</span><div class="stat-lbl">Logged</div></div>
        <div style="text-align:center"><span class="stat-val" id="s-done">0</span><div class="stat-lbl">EPAs Done</div></div>
        <div style="text-align:center"><span class="stat-val" id="s-rem">32</span><div class="stat-lbl">Remaining</div></div>
        <div style="text-align:center"><span class="stat-val" id="s-pct">0%</span><div class="stat-lbl">Complete</div></div>
      </div>
      <div class="prog-label"><span>Overall Progress</span><span id="prog-pct">0%</span></div>
      <div class="prog-track"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
    </div>
  </div>
  <div class="content">
    <div class="stage-tabs">
      <button class="stage-tab active-all" onclick="filterStage('all',this)">All EPAs</button>
      <button class="stage-tab" onclick="filterStage('TTD',this)">Transition to Discipline</button>
      <button class="stage-tab" onclick="filterStage('Foundations',this)">Foundations</button>
      <button class="stage-tab" onclick="filterStage('Core',this)">Core</button>
      <button class="stage-tab" onclick="filterStage('TTP',this)">Transition to Practice</button>
    </div>
    <div class="epa-list" id="epa-list"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAoWVsr7j98hahB_FFN7czD-0f_fCanZEw",
  authDomain: "epa-tracker.firebaseapp.com",
  projectId: "epa-tracker",
  storageBucket: "epa-tracker.firebasestorage.app",
  messagingSenderId: "87833807721",
  appId: "1:87833807721:web:7f6c54fe9d4730f17e8bf8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const EPAS=[
{id:"TTD-1",stage:"TTD",num:1,title:"Performing and presenting a basic history and physical examination",desc:"Focuses on clinical assessment, verifying skills from medical school. Does not include diagnosis, management, or communication of plan.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 4 total (‚â•2 by supervisor, ‚â•2 complete encounters)",t:4},{k:"neo",l:"Neonate or Infant",d:"At least 1",t:1},{k:"pre",l:"Preschool or School Age",d:"At least 1",t:1},{k:"adol",l:"Adolescent",d:"At least 1",t:1}]},
{id:"TTD-2",stage:"TTD",num:2,title:"Documenting orders for pediatric patients",desc:"Written documentation of orders after discussing with supervisor or senior resident.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 6 total (‚â•3 by supervisor)",t:6},{k:"neo",l:"Neonate/Infant order",d:"At least 1",t:1},{k:"child",l:"Child/Adolescent order",d:"At least 1",t:1},{k:"med",l:"Medication/Prescription order",d:"At least 1",t:1},{k:"iv",l:"IV Fluids order",d:"At least 1",t:1},{k:"diet",l:"Diet/Nutrition order",d:"At least 1",t:1}]},
{id:"F-1",stage:"Foundations",num:1,title:"Recognizing deteriorating and/or critically ill patients",desc:"Recognizing when a patient requires timely intervention and initiating necessary interventions including BLS and ALS.",reqs:[{k:"obs",l:"Total Observations",d:"Collect ‚â•5 total (‚â•1 pediatrician, ‚â•3 different observers)",t:5},{k:"neo",l:"Neonate",d:"At least 1",t:1},{k:"inf",l:"Infant",d:"At least 1",t:1},{k:"pre",l:"Preschool/School Age/Adolescent",d:"At least 1",t:1},{k:"pres",l:"Different clinical presentations",d:"At least 3",t:3}]},
{id:"F-2",stage:"Foundations",num:2,title:"Managing low risk deliveries and initiating resuscitation",desc:"Recognizing features of normal/abnormal fetal to neonatal transition, standard newborn care and initiating basic NRP.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 5 total (‚â•2 different observers, ‚â§2 simulation)",t:5},{k:"res",l:"Initiations of resuscitation",d:"At least 3",t:3}]},
{id:"F-3",stage:"Foundations",num:3,title:"Providing well newborn care",desc:"Care to healthy newborns, routine screening exam, and discharge counselling. Part A: newborn exam. Part B: discharge assessment.",reqs:[{k:"pa",l:"Part A: Newborn Exam observations",d:"Collect 5 (‚â•2 different observers)",t:5},{k:"pb",l:"Part B: Discharge Assessment observations",d:"Collect 5 (‚â•2 different observers)",t:5}]},
{id:"F-4",stage:"Foundations",num:4,title:"Assessing newborns with common problems",desc:"H&P for newborns with common problems (hyperbilirubinemia, hypoglycemia, NAS, poor weight gain, respiratory distress, sepsis risk).",reqs:[{k:"obs",l:"Total Observations",d:"Collect 3 total",t:3},{k:"pres",l:"Different presentations",d:"At least 2 different",t:2}]},
{id:"F-5",stage:"Foundations",num:5,title:"Assessing, diagnosing, and managing common pediatric problems",desc:"Comprehensive/targeted H&P for common pediatric presentations. Does not include critically ill or complex multisystem patients.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 10 total (‚â•5 direct, ‚â•5 attending, ‚â•5 observers)",t:10},{k:"dir",l:"Direct observations of H&P",d:"At least 5",t:5},{k:"age",l:"Age groups covered",d:"All 5 age groups",t:5},{k:"cond",l:"Types of conditions",d:"At least 5 types",t:5},{k:"resp",l:"Respiratory distress case",d:"At least 1",t:1},{k:"deh",l:"Dehydration case",d:"At least 1",t:1},{k:"fev",l:"Fever case",d:"At least 1",t:1}]},
{id:"F-6",stage:"Foundations",num:6,title:"Providing primary and secondary preventive health care",desc:"Developmentally appropriate anticipatory guidance and preventive care for patients and families.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 5 total (‚â•1 direct, ‚â•2 different observers)",t:5},{k:"dir",l:"Direct observation",d:"At least 1",t:1},{k:"age",l:"Age groups",d:"All 5 age groups",t:5},{k:"chr",l:"Chronic disease case",d:"At least 1",t:1},{k:"vul",l:"Vulnerable population case",d:"At least 1",t:1}]},
{id:"F-7",stage:"Foundations",num:7,title:"Performing basic pediatric procedures",desc:"BVM ventilation, CPR, IO injection, LP (neonates/infants), tracheostomy tube change, needle thoracostomy in neonate.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 12 total",t:12},{k:"bvm",l:"Bag valve mask ventilation",d:"At least 4",t:4},{k:"cpr",l:"CPR*",d:"At least 2",t:2},{k:"trach",l:"Tracheostomy tube change*",d:"At least 1",t:1},{k:"io",l:"Intraosseous injection*",d:"At least 2",t:2},{k:"lp",l:"Lumbar puncture (neonate/infant)",d:"At least 2",t:2},{k:"nt",l:"Needle thoracostomy (neonate)*",d:"At least 1",t:1}]},
{id:"F-8",stage:"Foundations",num:8,title:"Communicating assessment findings to patients/families",desc:"Communication skills to convey information and engage family in shared decision-making. Does not include complex disclosures.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 5 total (‚â•2 supervisor, ‚â•2 different assessors)",t:5},{k:"yng",l:"Neonate, Infant, or Preschool",d:"At least 1",t:1},{k:"sch",l:"School Age case",d:"At least 1",t:1},{k:"adol",l:"Adolescent case",d:"At least 1",t:1}]},
{id:"F-9",stage:"Foundations",num:9,title:"Documenting clinical encounters",desc:"Written communication: assessment/progress notes, consult letters, discharge summaries, consult requests.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 4 total",t:4},{k:"adm",l:"Admission note",d:"At least 1",t:1},{k:"dis",l:"Discharge summary",d:"At least 1",t:1},{k:"prog",l:"Progress note",d:"At least 1",t:1},{k:"con",l:"Consult letter",d:"At least 1",t:1}]},
{id:"F-10",stage:"Foundations",num:10,title:"Transferring clinical information during handover",desc:"Communicating acute and ongoing info about patients between colleagues at transitions in physician responsibility.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 2 total",t:2}]},
{id:"F-11",stage:"Foundations",num:11,title:"Coordinating transitions of care for non-complex patients",desc:"Transferring patients from one setting to another or discharging. Does not include complex patients.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 4 total (‚â•2 different observers)",t:4},{k:"tr",l:"Transfer observation",d:"At least 1",t:1},{k:"dis",l:"Discharge observation",d:"At least 1",t:1}]},
{id:"C-1",stage:"Core",num:1,title:"Resuscitating and stabilizing neonates following delivery",desc:"Applying neonatal resuscitation guidelines, working with the resuscitation team. Includes high-risk deliveries.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 3 total (‚â•2 different observers)",t:3}]},
{id:"C-2",stage:"Core",num:2,title:"Resuscitating and stabilizing critically ill patients",desc:"Resuscitation and stabilization of critically ill pediatric patients. Includes debrief after acute event.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 5 total (‚â§1 simulation)",t:5},{k:"neo",l:"Neonate",d:"At least 1",t:1},{k:"inf",l:"Infant/Preschool",d:"At least 1",t:1},{k:"sch",l:"School Aged",d:"At least 1",t:1},{k:"adol",l:"Adolescent",d:"At least 1",t:1},{k:"pres",l:"Presentation types (resp, hemo, fluid/met, neuro)",d:"At least 1 of each = 4",t:4}]},
{id:"C-3",stage:"Core",num:3,title:"Assessing patients with medical and/or psychosocial complexity",desc:"H&P for patients with complex, competing conditions. Includes developing prioritized problem list with differential.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 4 total (‚â•2 direct, ‚â•2 different assessors)",t:4},{k:"dir",l:"Direct observations",d:"At least 2",t:2},{k:"cond",l:"Types of conditions",d:"At least 3 different",t:3}]},
{id:"C-4",stage:"Core",num:4,title:"Diagnosing and managing pediatric patients",desc:"Assessing, diagnosing and managing patients with acute presentation. Includes arranging follow-up. Does not include resuscitation.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 8 total (‚â•6 direct, ‚â•6 supervisor, ‚â•3 assessors)",t:8},{k:"dir",l:"Direct observations",d:"At least 6",t:6},{k:"neo",l:"Neonate cases",d:"At least 2",t:2},{k:"inf",l:"Infant/Preschool cases",d:"At least 2",t:2},{k:"sch",l:"School Age cases",d:"At least 2",t:2},{k:"adol",l:"Adolescent cases",d:"At least 2",t:2}]},
{id:"C-5",stage:"Core",num:5,title:"Providing ongoing management for chronic conditions",desc:"Comprehensive ongoing management including screening, surveillance, medication adherence. May include technology-dependent patients.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 8 total (‚â•3 direct, ‚â•5 different observers)",t:8},{k:"dir",l:"Direct observations",d:"At least 3",t:3},{k:"cond",l:"Different conditions covered",d:"At least 8 different conditions",t:8},{k:"com",l:"Community setting",d:"At least 1",t:1}]},
{id:"C-6",stage:"Core",num:6,title:"Assessing and managing patients with mental health issues",desc:"Recognition, assessment, and management of mental health issues (ADHD, anxiety, mood disorders, eating disorders, suicidal ideation, etc.).",reqs:[{k:"obs",l:"Total Observations",d:"Collect 5 total (‚â•3 different observers)",t:5},{k:"dir",l:"Direct observations",d:"At least 2",t:2},{k:"cond",l:"Different conditions",d:"At least 5 different",t:5},{k:"lon",l:"In longitudinal clinic",d:"At least 1",t:1},{k:"com",l:"In community setting",d:"At least 2",t:2}]},
{id:"C-7",stage:"Core",num:7,title:"Assessing patients with developmental, behavioural, and school issues",desc:"Recognition, assessment, and management of ASD, behaviour problems, learning difficulties, developmental disorders, sleep issues.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 5 total (‚â•3 different observers)",t:5},{k:"dir",l:"Direct observations",d:"At least 2",t:2},{k:"cond",l:"Different conditions",d:"At least 4 different",t:4},{k:"lon",l:"In longitudinal clinic",d:"At least 2",t:2},{k:"com",l:"In community setting",d:"At least 2",t:2}]},
{id:"C-8",stage:"Core",num:8,title:"Recognizing and managing suspected child maltreatment",desc:"Recognizing and managing physical, emotional, sexual maltreatment or neglect. Includes mandatory reporting.",reqs:[{k:"obs",l:"Total Observations",d:"Collect ‚â•3 total",t:3},{k:"phy",l:"Physical maltreatment (incl. suspected)",d:"At least 1",t:1},{k:"sex",l:"Sexual maltreatment (incl. suspected)",d:"At least 1",t:1},{k:"neg",l:"Neglect (incl. suspected)",d:"At least 1",t:1}]},
{id:"C-9",stage:"Core",num:9,title:"Performing core pediatric procedures",desc:"Port-a-cath, CPR (defib), chest tube, ear curettage, G-tube, immunizations, intubation, IV, LP, NG tube, phlebotomy, surfactant, UAL, UVL, urinary cath, and more.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 33 total",t:33},{k:"pac",l:"Port-a-cath access*",d:"At least 1",t:1},{k:"def",l:"CPR defibrillation*",d:"At least 1",t:1},{k:"cht",l:"Chest tube*",d:"At least 2",t:2},{k:"ear",l:"Ear curettage",d:"At least 2",t:2},{k:"gtu",l:"G-tube reinsertion*",d:"At least 1",t:1},{k:"imm",l:"Immunizations (IM and SC)*",d:"At least 2",t:2},{k:"int",l:"Intubation (neonate/infant)",d:"At least 3",t:3},{k:"ivi",l:"IV insertion",d:"At least 2",t:2},{k:"lpu",l:"LP ¬± injection (preschool/school)",d:"At least 2",t:2},{k:"occ",l:"Long-term line occlusion management*",d:"At least 1",t:1},{k:"ngt",l:"Nasogastric tube",d:"At least 3",t:3},{k:"nps",l:"Nasopharyngeal swab",d:"At least 1",t:1},{k:"ekg",l:"EKG",d:"At least 1",t:1},{k:"phl",l:"Phlebotomy",d:"At least 3",t:3},{k:"sur",l:"Surfactant administration (neonate)",d:"At least 2",t:2},{k:"thr",l:"Throat swab",d:"At least 1",t:1},{k:"ual",l:"Umbilical arterial line",d:"At least 1",t:1},{k:"uvl",l:"Umbilical venous line",d:"At least 2",t:2},{k:"uca",l:"Urinary catheterization (1 boy, 1 girl)",d:"At least 2",t:2}]},
{id:"C-10",stage:"Core",num:10,title:"Leading discussions in emotionally charged situations",desc:"Advanced communication in difficult situations: managing conflict, disclosing errors, addressing non-adherence, breaking bad news.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 5 total (‚â•4 different supervisor observers)",t:5},{k:"typ",l:"Communication types",d:"At least 3 different",t:3},{k:"set",l:"Settings (inpatient, outpatient, ICU)",d:"At least 1 from each",t:3},{k:"adol",l:"Communication with adolescent",d:"At least 1",t:1}]},
{id:"C-11",stage:"Core",num:11,title:"Coordinating transitions of care for complex patients",desc:"Complex scenarios requiring coordination of multiple teams. Includes inter-facility transfer, discharge, and transition to adult care.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 4 total (‚â•2 different observers)",t:4},{k:"tr",l:"Transfer of care",d:"At least 1",t:1},{k:"dis",l:"Discharge",d:"At least 1",t:1}]},
{id:"C-12",stage:"Core",num:12,title:"Leading the inpatient team",desc:"Efficient leadership of inpatient service as senior resident. Based on at least one week of observation.",reqs:[{k:"obs",l:"Observations (‚â•1 week each)",d:"Collect 2 observations",t:2}]},
{id:"C-13",stage:"Core",num:13,title:"Advancing the discipline through scholarly activity",desc:"Completion of a scholarly project (basic/clinical science, advocacy, medical education, patient safety, QI, knowledge translation).",reqs:[{k:"pro",l:"Scholarly project completed",d:"1 observation of achievement",t:1}]},
{id:"C-14",stage:"Core",num:14,title:"Providing teaching and feedback",desc:"Role as teacher of junior learners. Part A: teaching (4 obs). Part B: assessing and providing feedback (2 obs).",reqs:[{k:"pa",l:"Part A: Teaching observations",d:"Collect 4 (variety of events)",t:4},{k:"pb",l:"Part B: Feedback observations",d:"Collect 2 (‚â•1 challenging situation)",t:2}]},
{id:"TTP-1",stage:"TTP",num:1,title:"Leading a general pediatric inpatient service",desc:"Independent management of inpatient service as physician most responsible. Part A: patient care. Part B: interprofessional care/supervision.",reqs:[{k:"pa",l:"Part A: Patient care observations",d:"Collect 3 (‚â•1 high complexity, 2 supervisors)",t:3},{k:"pb",l:"Part B: Interprofessional/supervision feedback",d:"Feedback from ‚â•3 observers",t:3}]},
{id:"TTP-2",stage:"TTP",num:2,title:"Managing longitudinal aspects of outpatient care",desc:"Longitudinal management of general pediatric outpatient clinic as physician most responsible.",reqs:[{k:"obs",l:"Observations at 1-3 month intervals",d:"At least 2 observations",t:2}]},
{id:"TTP-3",stage:"TTP",num:3,title:"Leading discussions about goals of care",desc:"Advanced communication about progression of illness and goals of care. Includes legal and ethical aspects.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 2 (‚â§1 simulation)",t:2}]},
{id:"TTP-4",stage:"TTP",num:4,title:"Leading family and interprofessional team meetings",desc:"Leading meetings to discuss clinical status, clarify expectations, set treatment goals, and facilitate discharge planning.",reqs:[{k:"obs",l:"Total Observations",d:"Collect 4 (‚â•2 family, ‚â•2 team, ‚â•1 direct supervisor)",t:4},{k:"fam",l:"Family meetings",d:"At least 2",t:2},{k:"team",l:"Team meetings",d:"At least 2",t:2}]},
{id:"TTP-5",stage:"TTP",num:5,title:"Analyzing patient safety events",desc:"Review and analysis of a patient safety event, identifying human and system factors. Presented at rounds or submitted as report.",reqs:[{k:"obs",l:"Observation of Achievement",d:"Collect 1",t:1}]},
];

const STAGE_COLOR={TTD:"#2563eb",Foundations:"#059669",Core:"#7c3aed",TTP:"#dc2626"};
let progress={}, activeStage="all", currentUser=null, saveTimer=null;

// ‚îÄ‚îÄ SIMPLE HASH (no email, no Firebase Auth) ‚îÄ‚îÄ
function hashPw(pw){
  let h=5381;
  for(let i=0;i<pw.length;i++) h=((h<<5)+h)+pw.charCodeAt(i);
  return (h>>>0).toString(36)+"_"+pw.length;
}

// ‚îÄ‚îÄ CHECK SESSION ‚îÄ‚îÄ
async function init(){
  const saved=localStorage.getItem("epa_session_user");
  if(saved){
    try{
      const snap=await getDoc(doc(db,"users",saved.toLowerCase()));
      if(snap.exists()){
        await loginUser(snap.data());
        return;
      }
    } catch(e){}
  }
  document.getElementById("loading-screen").style.display="none";
  document.getElementById("auth-screen").style.display="flex";
}
init();

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
window.showTab = function(tab){
  document.getElementById("tab-login").classList.toggle("active",tab==="login");
  document.getElementById("tab-register").classList.toggle("active",tab==="register");
  document.getElementById("form-login").style.display=tab==="login"?"block":"none";
  document.getElementById("form-register").style.display=tab==="register"?"block":"none";
  clearError();
};

window.doRegister = async function(){
  clearError();
  const name=document.getElementById("reg-name").value.trim();
  const username=document.getElementById("reg-user").value.trim().toLowerCase();
  const pass=document.getElementById("reg-pass").value;
  const pass2=document.getElementById("reg-pass2").value;
  if(!name||!username||!pass||!pass2) return showError("Please fill in all fields.");
  if(!/^[a-z0-9_]+$/.test(username)) return showError("Username can only contain letters, numbers, and underscores.");
  if(pass!==pass2) return showError("Passwords do not match.");
  if(pass.length<6) return showError("Password must be at least 6 characters.");
  setBtnLoading("reg-btn","Creating account‚Ä¶");
  try{
    const existing=await getDoc(doc(db,"users",username));
    if(existing.exists()){ resetBtn("reg-btn","Create Account ‚Üí"); return showError("Username already taken. Please choose another."); }
    const userData={username, displayName:name, pwHash:hashPw(pass), createdAt:new Date().toISOString()};
    await setDoc(doc(db,"users",username),userData);
    await loginUser(userData);
  } catch(e){
    resetBtn("reg-btn","Create Account ‚Üí");
    showError("Registration failed. Please check your connection and try again.");
  }
};

window.doLogin = async function(){
  clearError();
  const username=document.getElementById("login-user").value.trim().toLowerCase();
  const pass=document.getElementById("login-pass").value;
  if(!username||!pass) return showError("Please enter your username and password.");
  setBtnLoading("login-btn","Signing in‚Ä¶");
  try{
    const snap=await getDoc(doc(db,"users",username));
    if(!snap.exists()){ resetBtn("login-btn","Sign In ‚Üí"); return showError("Username not found. Please check or register."); }
    const userData=snap.data();
    if(userData.pwHash!==hashPw(pass)){ resetBtn("login-btn","Sign In ‚Üí"); return showError("Incorrect password. Please try again."); }
    await loginUser(userData);
  } catch(e){
    resetBtn("login-btn","Sign In ‚Üí");
    showError("Sign in failed. Please check your connection and try again.");
  }
};

async function loginUser(userData){
  currentUser=userData;
  localStorage.setItem("epa_session_user",userData.username);
  try{
    const snap=await getDoc(doc(db,"progress",userData.username));
    progress=snap.exists()?(snap.data().data||{}):{};
  } catch(e){ progress={}; }
  document.getElementById("loading-screen").style.display="none";
  document.getElementById("auth-screen").style.display="none";
  document.getElementById("app-screen").style.display="block";
  document.getElementById("user-display").textContent=userData.displayName||userData.username;
  renderEPAs();
  updateStats();
}

window.doSignOut = function(){
  localStorage.removeItem("epa_session_user");
  currentUser=null; progress={};
  document.getElementById("app-screen").style.display="none";
  document.getElementById("auth-screen").style.display="flex";
  document.getElementById("login-user").value="";
  document.getElementById("login-pass").value="";
  clearError();
  window.showTab("login");
};

function showError(msg){ const e=document.getElementById("auth-error"); e.textContent=msg; e.style.display="block"; }
function clearError(){ document.getElementById("auth-error").style.display="none"; }
function setBtnLoading(id,txt){ const b=document.getElementById(id); b.disabled=true; b.textContent=txt; }
function resetBtn(id,txt){ const b=document.getElementById(id); b.disabled=false; b.textContent=txt; }

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
async function saveToCloud(){
  if(!currentUser) return;
  try{
    await setDoc(doc(db,"progress",currentUser.username),{data:progress,updatedAt:new Date().toISOString()});
    const el=document.getElementById("save-msg");
    el.textContent="‚òÅÔ∏è Saved";
    setTimeout(()=>{ el.textContent=""; },2000);
  } catch(e){ document.getElementById("save-msg").textContent="‚ö† Save failed"; }
}

// ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ
function getCount(epaId,k){ return(progress[epaId]&&progress[epaId][k])||0; }

window.changeCount=function(epaId,k,delta,target){
  const cur=getCount(epaId,k);
  const val=Math.min(target,Math.max(0,cur+delta));
  if(!progress[epaId]) progress[epaId]={};
  progress[epaId][k]=val;
  updateCard(epaId);
  updateStats();
  clearTimeout(saveTimer);
  saveTimer=setTimeout(saveToCloud,800);
};

function isEPADone(epa){ return epa.reqs.every(r=>getCount(epa.id,r.k)>=r.t); }
function metReqs(epa){ return epa.reqs.filter(r=>getCount(epa.id,r.k)>=r.t).length; }

function updateStats(){
  const done=EPAS.filter(isEPADone).length;
  const pct=Math.round((done/EPAS.length)*100);
  let obs=0; EPAS.forEach(e=>e.reqs.forEach(r=>{ obs+=getCount(e.id,r.k); }));
  document.getElementById("s-obs").textContent=obs;
  document.getElementById("s-done").textContent=done;
  document.getElementById("s-rem").textContent=EPAS.length-done;
  document.getElementById("s-pct").textContent=pct+"%";
  document.getElementById("prog-fill").style.width=pct+"%";
  document.getElementById("prog-pct").textContent=pct+"%";
}

window.filterStage=function(stage,btn){
  activeStage=stage;
  document.querySelectorAll(".stage-tab").forEach(t=>{ t.className="stage-tab"; });
  btn.className="stage-tab active-"+stage;
  renderEPAs();
};

function renderEPAs(){
  const list=document.getElementById("epa-list");
  list.innerHTML="";
  const filtered=activeStage==="all"?EPAS:EPAS.filter(e=>e.stage===activeStage);
  filtered.forEach(epa=>{
    const card=document.createElement("div");
    card.className="epa-card"+(isEPADone(epa)?" epa-done":"");
    card.dataset.stage=epa.stage;
    card.dataset.id=epa.id;
    const met=metReqs(epa);
    const pct=Math.round((met/epa.reqs.length)*100);
    const color=STAGE_COLOR[epa.stage];
    const shortStage=epa.stage==="Foundations"?"F":epa.stage;
    const reqsHtml=epa.reqs.map(r=>{
      const cnt=getCount(epa.id,r.k);
      const done=cnt>=r.t;
      return `<div class="req-row${done?" req-complete":""}">
        <div class="req-info"><div class="req-name${done?" req-name-done":""}">${r.l}</div><div class="req-detail">${r.d}</div></div>
        <div class="counter">
          <button class="cbtn cbtn-minus" onclick="event.stopPropagation();changeCount('${epa.id}','${r.k}',-1,${r.t})"${cnt<=0?" disabled":""}>‚àí</button>
          <span class="cval" id="cv-${epa.id}-${r.k}">${cnt}</span>
          <button class="cbtn cbtn-plus" onclick="event.stopPropagation();changeCount('${epa.id}','${r.k}',1,${r.t})"${cnt>=r.t?" disabled":""}>+</button>
          <span class="req-target">/ ${r.t}</span>
          <span class="req-tick">${done?"‚úÖ":""}</span>
        </div>
      </div>`;
    }).join("");
    card.innerHTML=`
      <div class="epa-header" onclick="toggleCard('${epa.id}')">
        <span class="epa-badge badge-${epa.stage}">${shortStage} #${epa.num}</span>
        <div class="epa-title-wrap"><div class="epa-title">${epa.title}</div><div class="epa-subtitle">${met}/${epa.reqs.length} requirements met</div></div>
        <div class="epa-right">
          <div class="mini-bar"><div class="mini-fill" style="width:${pct}%;background:${isEPADone(epa)?"#c9962a":color}"></div></div>
          <span class="mini-pct">${pct}%</span>
          ${isEPADone(epa)?"<span>‚úÖ</span>":""}
          <span class="chevron">‚ñº</span>
        </div>
      </div>
      <div class="epa-body">
        <p class="epa-desc">${epa.desc}</p>
        <div class="req-section-title">Requirements</div>
        <div class="req-list">${reqsHtml}</div>
        ${isEPADone(epa)?'<div class="complete-badge">üèÖ EPA Completed</div>':''}
      </div>`;
    list.appendChild(card);
  });
}

window.toggleCard=function(id){
  const card=document.querySelector(`.epa-card[data-id="${id}"]`);
  if(card) card.classList.toggle("open");
};

function updateCard(epaId){
  const card=document.querySelector(`.epa-card[data-id="${epaId}"]`);
  if(!card) return;
  const epa=EPAS.find(e=>e.id===epaId);
  epa.reqs.forEach(r=>{
    const cnt=getCount(epaId,r.k);
    const done=cnt>=r.t;
    const valEl=card.querySelector(`#cv-${epaId}-${r.k}`);
    if(valEl){
      valEl.textContent=cnt;
      const row=valEl.closest(".counter");
      if(row){ row.querySelector(".cbtn-minus").disabled=cnt<=0; row.querySelector(".cbtn-plus").disabled=cnt>=r.t; }
      const reqRow=valEl.closest(".req-row");
      if(reqRow){
        reqRow.classList.toggle("req-complete",done);
        reqRow.querySelector(".req-name").classList.toggle("req-name-done",done);
        reqRow.querySelector(".req-tick").textContent=done?"‚úÖ":"";
      }
    }
  });
  const done=isEPADone(epa);
  card.classList.toggle("epa-done",done);
  const met=metReqs(epa);
  const pct=Math.round((met/epa.reqs.length)*100);
  card.querySelector(".epa-subtitle").textContent=`${met}/${epa.reqs.length} requirements met`;
  const fill=card.querySelector(".mini-fill");
  if(fill){ fill.style.width=pct+"%"; fill.style.background=done?"#c9962a":STAGE_COLOR[epa.stage]; }
  card.querySelector(".mini-pct").textContent=pct+"%";
}

// Enter key
["login-user","login-pass"].forEach(id=>{ document.getElementById(id)?.addEventListener("keydown",e=>{ if(e.key==="Enter") window.doLogin(); }); });
["reg-name","reg-user","reg-pass","reg-pass2"].forEach(id=>{ document.getElementById(id)?.addEventListener("keydown",e=>{ if(e.key==="Enter") window.doRegister(); }); });
</script>
</body>
</html>
